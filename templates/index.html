<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>聊天记录导出工具</title>
  <style>
    /* 简单样式可选 */
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans SC", Arial; padding: 24px; }
    .chat-export-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.3); align-items:center; justify-content:center; }
    .modal-container { background: #fff; width: 520px; max-width: 92vw; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,.2);}
    .modal-header, .modal-footer { padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; }
    .modal-header { border-bottom: 1px solid #eee; }
    .modal-body { padding: 16px; }
    .form-group { margin-bottom: 12px; }
    label { display:block; margin-bottom: 6px; font-weight: 600;}
    input[type="date"], input[type="text"] { width: 100%; padding: 8px; border:1px solid #ddd; border-radius: 8px; }
    .date-range { display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center; }
    .btn { padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-cancel, .close-btn { background: #eee; }
  </style>
</head>
<body>
  <h1>聊天记录导出工具</h1>
  <p>端口：<code>http://127.0.0.1:5001</code></p>

  <button id="open-export-modal" class="btn btn-primary">导出聊天记录</button>

  <!-- 引入你的弹窗模板 -->
  {% include "export_modal.html" %}

  <script>
    // 简单的事件绑定与请求逻辑
    const modal = document.querySelector('.chat-export-modal');
    const openBtn = document.getElementById('open-export-modal');
    const closeBtn = document.querySelector('.close-btn');
    const cancelBtn = document.querySelector('.btn-cancel');
    const submitBtn = document.getElementById('export-submit');

    // ✅ 临时加入一个用户名输入（后端必须要有 username）
    //    如果你希望做成隐藏字段/自动填充，也可以；为了直观，这里动态插入一个表单项。
    (function ensureUsernameField(){
      const body = document.querySelector('.modal-body');
      if (!document.getElementById('username')) {
        const wrap = document.createElement('div');
        wrap.className = 'form-group';
        wrap.innerHTML = `
          <label>用户名</label>
          <input type="text" id="username" placeholder="请输入要导出的用户名，例如：GUMI">
        `;
        body.prepend(wrap);
      }
    })();

    openBtn.onclick = () => modal.style.display = 'flex';
    const closeModal = () => modal.style.display = 'none';
    closeBtn.onclick = closeModal;
    cancelBtn.onclick = closeModal;
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

    submitBtn.onclick = async () => {
      const username = document.getElementById('username').value.trim();
      const start = document.getElementById('start-date').value;
      const end = document.getElementById('end-date').value;
      const channel = document.getElementById('channel-name').value.trim() || '六度世界聊天区';

      if (!username || !start || !end) {
        alert('请填写用户名与日期范围');
        return;
      }

      try {
        const resp = await fetch('http://127.0.0.1:5001/api/export-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: username,
            start_date: start,
            end_date: end,
            channel_name: channel
          })
        });
        const data = await resp.json();
        if (data.status === 'success' && data.download_url) {
          // 直接触发下载
          window.location.href = data.download_url.startsWith('http')
            ? data.download_url
            : ('http://127.0.0.1:5001' + data.download_url);
          closeModal();
        } else {
          alert('导出失败：' + (data.message || '未知错误'));
        }
      } catch (err) {
        alert('请求失败：' + err.message);
      }
    };
  </script>
</body>
</html>
